<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Land Suitability - Native Forest Co</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y9MVJYX7Q2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-Y9MVJYX7Q2', {
            page_title: 'Land Suitability Assessment',
            page_location: window.location.href,
            allow_google_signals: true,
            allow_ad_personalization_signals: false
        });
    </script>
    
    <!-- Load Leaflet CSS first -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <!-- Load fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Critical CSS for website - inline to prevent conflicts */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #2d3748;
            background-color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Navigation */
        .navbar {
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .nav-brand h2 {
            color: #2f5233;
            font-weight: 600;
            font-size: 1.5rem;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-link {
            text-decoration: none;
            color: #4a5568;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #2f5233;
        }

        /* Page Header */
        .page-header {
            margin-top: 70px;
            padding: 60px 0 40px 0;
            background: #f8fffe;
            text-align: center;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a2f1c;
            margin-bottom: 1rem;
        }

        .page-subtitle {
            font-size: 1.125rem;
            color: #4a5568;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Map Section */
        .map-section {
            background: white;
            min-height: 80vh;
        }

        .map-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            height: 80vh;
            border-top: 1px solid #e2e8f0;
        }

        .map-controls {
            background: #f8fffe;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
        }

        .controls-header {
            background: #2f5233;
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .controls-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .control-section {
            padding: 20px;
            border-bottom: 1px solid #e6fffa;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #2f5233;
            color: white;
        }

        .btn-primary:hover {
            background: #1a2f1c;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .help-text {
            background: #f0fdf4;
            border: 1px solid #86efac;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .help-text h4 {
            margin: 0 0 10px 0;
            color: #15803d;
            font-size: 16px;
        }

        .help-text ul {
            margin: 0;
            padding-left: 20px;
        }

        .help-text li {
            margin: 5px 0;
            color: #166534;
            font-size: 13px;
        }

        .coordinates-display {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }

        .coordinates-display h4 {
            margin: 0 0 10px 0;
            color: #374151;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
        }

        .coord-item {
            margin: 5px 0;
            color: #4b5563;
        }

        .coord-value {
            color: #059669;
            font-weight: bold;
        }

        pre {
            background: #1f2937;
            color: #10b981;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Map Area */
        .map-wrapper {
            position: relative;
            background: #e8f4f8;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* User location marker styling */
        .user-location-marker {
            text-align: center;
            font-size: 24px;
            background: none !important;
            border: none !important;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Sections below map */
        .factors {
            padding: 80px 0;
            background: #f8fffe;
        }

        .factors h2 {
            text-align: center;
            font-size: 2.25rem;
            font-weight: 700;
            color: #1a2f1c;
            margin-bottom: 3rem;
        }

        .factors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .factor-card {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e6fffa;
            text-align: center;
        }

        .factor-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .factor-card h3 {
            color: #1a2f1c;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .factor-card p {
            color: #4a5568;
            line-height: 1.6;
        }

        /* Species Guide */
        .species-guide {
            padding: 80px 0;
            background: white;
        }

        .species-guide h2 {
            text-align: center;
            font-size: 2.25rem;
            font-weight: 700;
            color: #1a2f1c;
            margin-bottom: 3rem;
        }

        .species-tabs {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            border: 2px solid #2f5233;
            background: transparent;
            color: #2f5233;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .tab-btn.active,
        .tab-btn:hover {
            background: #2f5233;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .species-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .species-card {
            background: #f8fffe;
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid #e6fffa;
        }

        .species-card h4 {
            color: #1a2f1c;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .species-card p {
            color: #4a5568;
            line-height: 1.6;
        }

        /* CTA Section */
        .cta {
            padding: 80px 0;
            background: #2f5233;
            color: white;
            text-align: center;
        }

        .cta h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .cta p {
            font-size: 1.125rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .btn-primary-light {
            background: white;
            color: #2f5233;
            padding: 15px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .btn-primary-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        /* Footer */
        .footer {
            background: #1a2f1c;
            color: white;
            padding: 60px 0 20px 0;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-section h3,
        .footer-section h4 {
            margin-bottom: 1rem;
            color: #68d391;
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section ul li {
            margin-bottom: 0.5rem;
        }

        .footer-section a {
            color: #e2e8f0;
            text-decoration: none;
        }

        .footer-bottom {
            border-top: 1px solid #2d3748;
            padding-top: 2rem;
            text-align: center;
            color: #a0aec0;
        }

        /* Suitability Results Modal */
        .suitability-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .suitability-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 95%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.9) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #2f5233, #3d6b40);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            position: relative;
        }

        .modal-header h2 {
            margin: 0 0 8px 0;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .modal-header .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin: 0;
        }

        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 24px;
        }

        .overall-score-section {
            background: linear-gradient(135deg, #f0fff4, #e6fffa);
            border: 2px solid #68d391;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .score-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .score-number {
            font-size: 3rem;
            font-weight: 800;
            color: #2f5233;
        }

        .score-badge {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #68d391;
            font-weight: 600;
            color: #059669;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .data-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 18px;
        }

        .data-section h4 {
            margin: 0 0 12px 0;
            color: #2f5233;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-item {
            margin: 8px 0;
            font-size: 14px;
            line-height: 1.4;
        }

        .data-label {
            font-weight: 600;
            color: #374151;
        }

        .data-value {
            color: #059669;
            font-weight: 500;
        }

        .species-recommendations {
            background: #f8fffe;
            border: 1px solid #a7f3d0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .species-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .species-card {
            background: white;
            border: 1px solid #e6fffa;
            border-radius: 8px;
            padding: 16px;
        }

        .species-card h5 {
            margin: 0 0 8px 0;
            color: #1a2f1c;
            font-size: 1rem;
        }

        .species-type {
            background: #d1fae5;
            color: #065f46;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .references-section {
            background: #f1f5f9;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            margin-top: 24px;
            border-radius: 0 8px 8px 0;
        }

        .references-section h4 {
            margin: 0 0 12px 0;
            color: #1e40af;
            font-size: 0.95rem;
        }

        .reference-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .reference-item {
            margin: 8px 0;
            font-size: 12px;
            color: #475569;
            line-height: 1.4;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 14px;
        }

        .modal-btn-primary {
            background: #2f5233;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #1a2f1c;
            transform: translateY(-1px);
        }

        .modal-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .modal-btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .map-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .map-controls {
                order: 2;
                max-height: 400px;
            }

            .map-wrapper {
                order: 1;
                height: 60vh;
            }

            .nav-menu {
                display: none;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .modal-content {
                width: 98%;
                max-height: 92vh;
                margin: 10px;
            }

            .modal-header {
                padding: 20px;
            }

            .modal-header h2 {
                font-size: 1.5rem;
            }

            .modal-body {
                padding: 20px;
            }

            .data-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .species-grid {
                grid-template-columns: 1fr;
            }

            .modal-actions {
                flex-direction: column;
                gap: 8px;
            }

            .score-display {
                flex-direction: column;
                gap: 12px;
            }

            .score-number {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>Native Forest Co</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="about.html" class="nav-link">About</a></li>
                <li><a href="suitability.html" class="nav-link active">Land Suitability</a></li>
                <li><a href="contact.html" class="nav-link">Contact</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <!-- Page Header -->
        <section class="page-header">
            <div class="container">
                <h1>Measure Land Suitability</h1>
                <p class="page-subtitle">Use our interactive map to select your property and get precise GPS coordinates for professional land assessment</p>
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section">
            <div class="map-container">
                <div class="map-controls">
                    <div class="controls-header">
                        <h3>🗺️ Interactive Map Tools</h3>
                    </div>
                    
                    <div class="control-section">
                        <div class="control-buttons">
                            <button class="btn btn-primary" onclick="centerOnNZ()">🗺️ Center on New Zealand</button>
                            <button class="btn btn-secondary" onclick="showHelp()">❓ Show Instructions</button>
                            <button class="btn btn-danger" onclick="clearSelection()">🗑️ Clear Selection</button>
                            <button class="btn btn-primary" onclick="exportCoordinates()" id="export-btn" disabled>📤 Export GPS Data</button>
                            <button class="btn btn-primary" onclick="checkSuitability()" id="suitability-btn" disabled style="background: #059669; margin-top: 10px;">🌱 Check Suitability Now</button>
                        </div>

                        <div id="status" class="status-message status-info">
                            🔄 Initializing interactive map...
                        </div>

                        <div class="help-text" id="help-section">
                            <h4>📍 How to Select Land Areas:</h4>
                            <ul>
                                <li><strong>Pan:</strong> Click and drag to move around</li>
                                <li><strong>Zoom:</strong> Use scroll wheel or +/- buttons</li>
                                <li><strong>Polygon:</strong> Click points, double-click to finish</li>
                                <li><strong>Rectangle:</strong> Click and drag diagonally</li>
                                <li><strong>Circle:</strong> Click center, drag radius</li>
                                <li><strong>Edit/Delete:</strong> Use tools in top-right corner</li>
                            </ul>
                        </div>

                        <div id="coordinates-display" class="coordinates-display" style="display: none;">
                            <h4>📍 Selected Area Details</h4>
                            <div id="coord-details"></div>
                        </div>

                        <div id="api-data" style="display: none;">
                            <details>
                                <summary style="cursor: pointer; color: #2f5233; font-weight: bold; margin-bottom: 10px;">🔧 GPS Data for API Integration</summary>
                                <pre id="api-json"></pre>
                            </details>
                        </div>

                        <div id="suitability-results" style="display: none;">
                            <div style="background: #f0fff4; border: 2px solid #68d391; border-radius: 8px; padding: 20px; margin: 15px 0;">
                                <h4 style="color: #059669; margin: 0 0 15px 0;">🌱 Land Suitability Report</h4>
                                <div id="suitability-content"></div>
                                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
                                    <h5 style="margin: 0 0 10px 0; color: #2f5233;">📊 Want the Complete Analysis?</h5>
                                    <p style="margin: 0 0 15px 0; font-size: 14px; color: #6c757d;">This is a preview. Register to access detailed soil composition, drainage patterns, species recommendations, and professional assessment.</p>
                                    <button onclick="showRegistration()" style="background: #2f5233; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                        📝 Register for Full Report
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="map-wrapper">
                    <div id="map"></div>
                </div>
            </div>
        </section>

        <!-- Suitability Factors -->
        <section class="factors">
            <div class="container">
                <h2>What Makes Land Suitable?</h2>
                <div class="factors-grid">
                    <div class="factor-card">
                        <div class="factor-icon">🏔️</div>
                        <h3>Slope & Topography</h3>
                        <p>Steep slopes (15-35°) are ideal for native forest as they're often unsuitable for agriculture and benefit from erosion control.</p>
                    </div>
                    <div class="factor-card">
                        <div class="factor-icon">🌧️</div>
                        <h3>Drainage & Water</h3>
                        <p>Well-drained areas are preferred, though some native species thrive in wetter conditions. Proximity to waterways adds conservation value.</p>
                    </div>
                    <div class="factor-card">
                        <div class="factor-icon">🌱</div>
                        <h3>Soil Quality</h3>
                        <p>Native trees can improve poor soils over time. Areas with erosion risk or low fertility are often perfect candidates.</p>
                    </div>
                    <div class="factor-card">
                        <div class="factor-icon">📍</div>
                        <h3>Location & Access</h3>
                        <p>Areas need vehicle access for planting equipment. Proximity to existing native vegetation creates wildlife corridors.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Species Guide -->
        <section class="species-guide">
            <div class="container">
                <h2>Native Species for Different Conditions</h2>
                <div class="species-tabs">
                    <button class="tab-btn active" onclick="showTab('wet')">Wet Areas</button>
                    <button class="tab-btn" onclick="showTab('dry')">Dry Slopes</button>
                    <button class="tab-btn" onclick="showTab('coastal')">Coastal</button>
                    <button class="tab-btn" onclick="showTab('fast')">Fast Growing</button>
                </div>
                
                <div class="tab-content active" id="wet">
                    <div class="species-grid">
                        <div class="species-card">
                            <h4>Kahikatea</h4>
                            <p>New Zealand's tallest native tree, excellent for wet soils and floodplains.</p>
                        </div>
                        <div class="species-card">
                            <h4>Swamp Maire</h4>
                            <p>Hardy tree perfect for poorly drained soils and wet areas.</p>
                        </div>
                        <div class="species-card">
                            <h4>Cabbage Tree</h4>
                            <p>Fast-growing pioneer species that tolerates wet conditions.</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="dry">
                    <div class="species-grid">
                        <div class="species-card">
                            <h4>Kanuka</h4>
                            <p>Pioneer species excellent for dry, exposed sites and erosion control.</p>
                        </div>
                        <div class="species-card">
                            <h4>Kowhai</h4>
                            <p>Beautiful flowering tree that thrives on dry slopes and poor soils.</p>
                        </div>
                        <div class="species-card">
                            <h4>Matagouri</h4>
                            <p>Hardy shrub perfect for dry, windy conditions and erosion control.</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="coastal">
                    <div class="species-grid">
                        <div class="species-card">
                            <h4>Pohutukawa</h4>
                            <p>Iconic coastal tree that tolerates salt spray and windy conditions.</p>
                        </div>
                        <div class="species-card">
                            <h4>Karaka</h4>
                            <p>Large coastal tree excellent for shelter and bird habitat.</p>
                        </div>
                        <div class="species-card">
                            <h4>Taupata</h4>
                            <p>Low-growing coastal shrub perfect for exposed coastal sites.</p>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="fast">
                    <div class="species-grid">
                        <div class="species-card">
                            <h4>Manuka</h4>
                            <p>Fast-growing pioneer that quickly establishes ground cover and habitat.</p>
                        </div>
                        <div class="species-card">
                            <h4>Wattle</h4>
                            <p>Nitrogen-fixing tree that rapidly improves soil quality.</p>
                        </div>
                        <div class="species-card">
                            <h4>Tree Fern</h4>
                            <p>Quick-establishing understory that creates immediate forest feel.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="cta">
            <div class="container">
                <h2>Ready for a Professional Assessment?</h2>
                <p>Our experts can provide detailed site analysis and customized planting recommendations.</p>
                <a href="contact.html" class="btn-primary-light">Schedule Site Visit</a>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Native Forest Co</h3>
                    <p>Transforming New Zealand's landscape, one farm at a time.</p>
                </div>
                <div class="footer-section">
                    <h4>Services</h4>
                    <ul>
                        <li><a href="suitability.html">Land Assessment</a></li>
                        <li><a href="#">Forest Planning</a></li>
                        <li><a href="#">Native Planting</a></li>
                        <li><a href="#">Maintenance</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact</h4>
                    <ul>
                        <li>Email: info@nativeforest.co.nz</li>
                        <li>Phone: 0800 NATIVE</li>
                        <li>Auckland, New Zealand</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Native Forest Co. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Suitability Results Modal -->
    <div id="suitability-modal" class="suitability-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🌱 Land Suitability Analysis</h2>
                <p class="subtitle">Comprehensive environmental assessment report</p>
                <button class="modal-close-btn" onclick="closeSuitabilityModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-content">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Load Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <script>
        // Global variables
        let map = null;
        let drawnItems = null;
        let currentSelection = null;
        let userLocation = null;

        // Google Analytics Event Tracking
        function trackEvent(eventName, parameters = {}) {
            if (typeof gtag === 'function') {
                gtag('event', eventName, {
                    event_category: 'Land Assessment',
                    event_label: parameters.label || '',
                    value: parameters.value || 0,
                    ...parameters
                });
                console.log('📊 Analytics Event:', eventName, parameters);
            }
        }

        // Track user engagement metrics
        function trackUserEngagement() {
            // Track time on page
            let pageStartTime = Date.now();
            let engagementTimer;
            
            // Track meaningful engagement (30 seconds)
            setTimeout(() => {
                trackEvent('page_engagement', {
                    engagement_time_msec: 30000,
                    event_category: 'User Engagement',
                    custom_parameter_1: 'meaningful_visit'
                });
            }, 30000);

            // Track before user leaves
            window.addEventListener('beforeunload', () => {
                const timeOnPage = Date.now() - pageStartTime;
                trackEvent('page_view_complete', {
                    engagement_time_msec: timeOnPage,
                    event_category: 'User Engagement'
                });
            });
        }

        // Track search and location patterns
        function trackLocationSearch(location, zoomLevel) {
            trackEvent('map_search', {
                event_category: 'Map Interaction',
                custom_parameter_1: 'location_search',
                custom_parameter_2: zoomLevel.toString(),
                value: zoomLevel
            });
        }

        // Track user's geographic region (with privacy considerations)
        function trackUserRegion(lat, lng) {
            // Only track general region, not exact location
            let region = 'unknown';
            
            // New Zealand regions (general areas only)
            if (lat >= -47.5 && lat <= -34.0 && lng >= 166.0 && lng <= 179.0) {
                if (lat > -39) region = 'North Island';
                else if (lat > -42) region = 'Central NZ';
                else region = 'South Island';
            } else {
                region = 'International';
            }
            
            trackEvent('user_region_detected', {
                event_category: 'Geographic Data',
                custom_parameter_1: region,
                custom_parameter_2: 'privacy_safe'
            });
        }

        // Status update function
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Calculate geodesic area (more accurate for GPS coordinates)
        function calculateArea(latlngs) {
            if (!latlngs || latlngs.length < 3) return 0;
            
            // Using simplified shoelace formula adapted for geographic coordinates
            let area = 0;
            const R = 6371; // Earth's radius in km
            
            for (let i = 0; i < latlngs.length; i++) {
                const j = (i + 1) % latlngs.length;
                const lat1 = latlngs[i].lat * Math.PI / 180;
                const lat2 = latlngs[j].lat * Math.PI / 180;
                const deltaLng = (latlngs[j].lng - latlngs[i].lng) * Math.PI / 180;
                
                area += deltaLng * (2 + Math.sin(lat1) + Math.sin(lat2));
            }
            
            area = Math.abs(area * R * R / 2);
            return area * 100; // Convert to hectares
        }

        // Display coordinates and analysis
        function displayCoordinates(layer, type) {
            const coordDisplay = document.getElementById('coordinates-display');
            const coordDetails = document.getElementById('coord-details');
            const apiData = document.getElementById('api-data');
            const apiJson = document.getElementById('api-json');
            const exportBtn = document.getElementById('export-btn');
            const suitabilityBtn = document.getElementById('suitability-btn');
            
            coordDisplay.style.display = 'block';
            apiData.style.display = 'block';
            exportBtn.disabled = false;
            suitabilityBtn.disabled = false;
            
            // Make suitability button more prominent
            suitabilityBtn.style.cssText = `
                background: linear-gradient(135deg, #059669, #10b981);
                color: white;
                border: none;
                padding: 16px 24px;
                border-radius: 12px;
                cursor: pointer;
                font-size: 18px;
                font-weight: bold;
                margin-top: 15px;
                width: 100%;
                box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
                transition: all 0.3s ease;
                animation: pulse 2s infinite;
            `;
            
            // Add CSS animation for pulsing effect
            if (!document.getElementById('pulse-animation')) {
                const style = document.createElement('style');
                style.id = 'pulse-animation';
                style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
                        50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4); }
                        100% { transform: scale(1); box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            let html = '';
            let data = {
                type: type,
                timestamp: new Date().toISOString(),
                coordinates: [],
                bounds: null,
                area: null,
                center: null
            };
            
            if (type === 'circle') {
                const center = layer.getLatLng();
                const radius = layer.getRadius();
                
                data.center = { lat: center.lat, lng: center.lng };
                data.radius = radius;
                data.area = (Math.PI * radius * radius / 10000).toFixed(2); // hectares
                
                html = `
                    <div class="coord-item">Type: <span class="coord-value">Circle</span></div>
                    <div class="coord-item">Center: <span class="coord-value">${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}</span></div>
                    <div class="coord-item">Radius: <span class="coord-value">${radius.toFixed(0)}m</span></div>
                    <div class="coord-item">Area: <span class="coord-value">${data.area} hectares</span></div>
                `;
            } else {
                const latlngs = layer.getLatLngs()[0] || layer.getLatLngs();
                data.coordinates = latlngs.map(ll => ({ lat: ll.lat, lng: ll.lng }));
                data.area = calculateArea(latlngs).toFixed(2);
                
                // Calculate bounds
                const bounds = layer.getBounds();
                data.bounds = {
                    north: bounds.getNorth(),
                    south: bounds.getSouth(),
                    east: bounds.getEast(),
                    west: bounds.getWest()
                };
                
                // Calculate center
                const center = bounds.getCenter();
                data.center = { lat: center.lat, lng: center.lng };
                
                html = `
                    <div class="coord-item">Type: <span class="coord-value">${type}</span></div>
                    <div class="coord-item">Points: <span class="coord-value">${latlngs.length}</span></div>
                    <div class="coord-item">Area: <span class="coord-value">${data.area} hectares</span></div>
                    <div class="coord-item">Center: <span class="coord-value">${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}</span></div>
                    <div style="margin-top: 10px; font-weight: bold;">Boundary Coordinates:</div>
                `;
                
                latlngs.forEach((ll, i) => {
                    html += `<div class="coord-item">Point ${i+1}: <span class="coord-value">${ll.lat.toFixed(6)}, ${ll.lng.toFixed(6)}</span></div>`;
                });
            }
            
            coordDetails.innerHTML = html;
            currentSelection = data;
            apiJson.textContent = JSON.stringify(data, null, 2);
            
            updateStatus(`✅ ${type} selected! GPS coordinates captured. Area: ${data.area} hectares`, 'success');
            
            // Track area selection analytics
            trackEvent('area_selected', {
                event_category: 'Map Interaction',
                custom_parameter_1: type,
                custom_parameter_2: `${data.area}_hectares`,
                value: parseFloat(data.area)
            });
        }

        // Initialize map
        function initializeMap() {
            try {
                updateStatus('🗺️ Creating map instance...');
                
                // Create map with default New Zealand center
                map = L.map('map', {
                    center: [-41.2865, 174.7762],
                    zoom: 6,
                    minZoom: 5,
                    maxZoom: 18
                });
                
                // Try to get user's location for better initial zoom
                getUserLocationAndZoom();
                
                updateStatus('🌍 Loading map tiles...');
                
                // Add tile layers
                const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                });
                
                const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenTopoMap',
                    maxZoom: 17
                });
                
                // Add default layer
                osm.addTo(map);
                
                // Add layer control
                const baseLayers = {
                    "Street Map": osm,
                    "Topographical": topo
                };
                
                L.control.layers(baseLayers, null, { position: 'topleft' }).addTo(map);
                
                updateStatus('🖊️ Adding drawing tools...');
                
                // Initialize drawing features
                drawnItems = new L.FeatureGroup();
                map.addLayer(drawnItems);
                
                // Add draw control
                const drawControl = new L.Control.Draw({
                    position: 'topright',
                    draw: {
                        polygon: {
                            shapeOptions: {
                                color: '#2f5233',
                                weight: 3,
                                fillOpacity: 0.2
                            }
                        },
                        rectangle: {
                            shapeOptions: {
                                color: '#2f5233',
                                weight: 3,
                                fillOpacity: 0.2
                            }
                        },
                        circle: {
                            shapeOptions: {
                                color: '#2f5233',
                                weight: 3,
                                fillOpacity: 0.2
                            }
                        },
                        polyline: false,
                        marker: false,
                        circlemarker: false
                    },
                    edit: {
                        featureGroup: drawnItems
                    }
                });
                
                map.addControl(drawControl);
                
                // Handle draw events
                map.on('draw:created', function(e) {
                    drawnItems.clearLayers(); // Only one selection at a time
                    drawnItems.addLayer(e.layer);
                    displayCoordinates(e.layer, e.layerType);
                });
                
                map.on('draw:deleted', function() {
                    clearSelection();
                });
                
                // Add zoom control
                L.control.zoom({ position: 'topright' }).addTo(map);
                
                // Add scale
                L.control.scale().addTo(map);
                
                updateStatus('✅ Map ready! Use drawing tools (top-right) to select land areas.', 'success');
                
                // Force a resize to ensure proper rendering
                setTimeout(() => {
                    map.invalidateSize();
                }, 100);
                
            } catch (error) {
                updateStatus(`❌ Error: ${error.message}`, 'error');
                console.error('Map initialization failed:', error);
            }
        }

        // Get user's location and zoom to their area
        function getUserLocationAndZoom() {
            if (navigator.geolocation) {
                updateStatus('📍 Getting your location for better map view...', 'info');
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Check if location is in New Zealand (rough bounds)
                        const inNZ = (lat >= -47.5 && lat <= -34.0 && lng >= 166.0 && lng <= 179.0);
                        
                        if (inNZ && map) {
                            map.setView([lat, lng], 10);
                            updateStatus('📍 Map centered on your location in New Zealand', 'success');
                            
                            // Track user location for analytics (privacy-safe)
                            userLocation = { lat, lng };
                            trackUserRegion(lat, lng);
                            
                            trackEvent('location_detected', {
                                event_category: 'Geographic Data',
                                custom_parameter_1: 'new_zealand',
                                custom_parameter_2: 'auto_zoom_successful'
                            });
                            
                            // Add a temporary marker to show user's location
                            const userMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    html: '📍',
                                    iconSize: [30, 30],
                                    className: 'user-location-marker'
                                })
                            }).addTo(map);
                            
                            userMarker.bindPopup('📍 Your approximate location<br>Draw an area nearby to assess land suitability').openPopup();
                            
                            // Remove marker after 10 seconds
                            setTimeout(() => {
                                map.removeLayer(userMarker);
                            }, 10000);
                        } else if (map) {
                            // If outside NZ, stay centered on NZ but inform user
                            updateStatus('📍 Location detected outside New Zealand. Map centered on NZ.', 'info');
                        }
                    },
                    function(error) {
                        console.log('Geolocation error:', error);
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                updateStatus('📍 Location access denied. Map centered on New Zealand.', 'info');
                                break;
                            case error.POSITION_UNAVAILABLE:
                                updateStatus('📍 Location unavailable. Map centered on New Zealand.', 'info');
                                break;
                            case error.TIMEOUT:
                                updateStatus('📍 Location timeout. Map centered on New Zealand.', 'info');
                                break;
                            default:
                                updateStatus('📍 Location error. Map centered on New Zealand.', 'info');
                                break;
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes cache
                    }
                );
            } else {
                updateStatus('📍 Geolocation not supported. Map centered on New Zealand.', 'info');
            }
        }

        // Helper functions
        function centerOnNZ() {
            if (map) {
                map.setView([-41.2865, 174.7762], 6);
                updateStatus('📍 Centered on New Zealand', 'info');
                
                // Track manual map centering
                trackEvent('map_center_nz', {
                    event_category: 'Map Interaction',
                    custom_parameter_1: 'manual_center',
                    custom_parameter_2: 'new_zealand'
                });
            }
        }

        function showHelp() {
            const help = document.getElementById('help-section');
            help.style.display = help.style.display === 'none' ? 'block' : 'none';
        }

        function clearSelection() {
            if (drawnItems) {
                drawnItems.clearLayers();
            }
            document.getElementById('coordinates-display').style.display = 'none';
            document.getElementById('api-data').style.display = 'none';
            document.getElementById('suitability-results').style.display = 'none';
            document.getElementById('export-btn').disabled = true;
            
            const suitabilityBtn = document.getElementById('suitability-btn');
            suitabilityBtn.disabled = true;
            // Reset button style to default
            suitabilityBtn.style.cssText = `
                background: #059669;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                margin-top: 10px;
                width: 100%;
                transition: all 0.3s;
                opacity: 0.6;
            `;
            
            currentSelection = null;
            updateStatus('🗑️ Selection cleared. Draw a new area to begin analysis.', 'info');
        }

        function exportCoordinates() {
            if (!currentSelection) {
                updateStatus('⚠️ No area selected to export', 'error');
                return;
            }
            
            const dataStr = JSON.stringify(currentSelection, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `land-coordinates-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            updateStatus('📤 GPS coordinates exported successfully!', 'success');
            
            // Track coordinate export
            trackEvent('coordinates_exported', {
                event_category: 'Data Export',
                custom_parameter_1: currentSelection.type,
                custom_parameter_2: `${currentSelection.area}_hectares`,
                value: parseFloat(currentSelection.area)
            });
        }

        // Land Suitability Analysis Function
        async function checkSuitability() {
            if (!currentSelection) {
                updateStatus('⚠️ Please select an area first', 'error');
                return;
            }

            const suitabilityBtn = document.getElementById('suitability-btn');
            
            // Start thinking process
            suitabilityBtn.disabled = true;
            suitabilityBtn.innerHTML = '🔄 Analyzing...';
            updateStatus('🔍 Analyzing land suitability... This may take a moment.', 'info');

            try {
                // Show thinking messages
                const thinkingMessages = [
                    '🌍 Fetching elevation data...',
                    '🧪 Analyzing soil composition...',
                    '💧 Checking water sources and drainage...',
                    '🌱 Evaluating vegetation patterns...',
                    '☁️ Gathering climate data...',
                    '📊 Calculating suitability score...'
                ];

                let messageIndex = 0;
                const thinkingInterval = setInterval(() => {
                    if (messageIndex < thinkingMessages.length) {
                        updateStatus(thinkingMessages[messageIndex], 'info');
                        messageIndex++;
                    }
                }, 1500);

                // Simulate API calls with actual data gathering
                const results = await performSuitabilityAnalysis(currentSelection);
                
                clearInterval(thinkingInterval);
                
                // Show modal instead of sidebar results
                showSuitabilityModal(results);
                
                updateStatus('✅ Suitability analysis complete!', 'success');
                
                // Track suitability check completion
                trackEvent('suitability_check_completed', {
                    event_category: 'Assessment',
                    custom_parameter_1: currentSelection.type,
                    custom_parameter_2: `score_${results.overallScore}`,
                    value: results.overallScore
                });
                
            } catch (error) {
                updateStatus('❌ Analysis failed. Please try again.', 'error');
                console.error('Suitability analysis error:', error);
            } finally {
                suitabilityBtn.disabled = false;
                suitabilityBtn.innerHTML = '🌱 Check Suitability Now';
            }
        }

        // Perform actual suitability analysis using APIs
        async function performSuitabilityAnalysis(selection) {
            const center = selection.center;
            const results = {
                coordinates: center,
                area: selection.area,
                elevation: null,
                soil: null,
                climate: null,
                vegetation: null,
                waterProximity: null,
                overallScore: null
            };

            try {
                // 1. Get elevation data (Open-Elevation API)
                const elevationResponse = await fetch('https://api.open-elevation.com/api/v1/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        locations: [{ latitude: center.lat, longitude: center.lng }]
                    })
                });
                
                if (elevationResponse.ok) {
                    const elevationData = await elevationResponse.json();
                    results.elevation = elevationData.results[0]?.elevation || null;
                }

                // 2. Get climate data (Open-Meteo API)
                const climateResponse = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${center.lat}&longitude=${center.lng}&current=temperature_2m,precipitation&daily=precipitation_sum,temperature_2m_max,temperature_2m_min&past_days=30&forecast_days=1`
                );
                
                if (climateResponse.ok) {
                    const climateData = await climateResponse.json();
                    results.climate = {
                        currentTemp: climateData.current?.temperature_2m,
                        avgPrecipitation: climateData.daily?.precipitation_sum?.slice(0, 30).reduce((a, b) => a + b, 0) / 30,
                        avgTempMax: climateData.daily?.temperature_2m_max?.slice(0, 30).reduce((a, b) => a + b, 0) / 30
                    };
                }

                // 3. Simulate soil data (would use SoilGrids API in production)
                results.soil = {
                    pH: 6.2 + (Math.random() - 0.5) * 2,
                    organicCarbon: 2.5 + (Math.random() - 0.5) * 3,
                    drainage: ['Well-drained', 'Moderately drained', 'Poorly drained'][Math.floor(Math.random() * 3)]
                };

                // 4. Calculate proximity to water (simulated)
                results.waterProximity = Math.floor(Math.random() * 2000) + 100; // meters

                // 5. Simulate vegetation index
                results.vegetation = {
                    ndvi: 0.3 + Math.random() * 0.4,
                    landCover: ['Grassland', 'Mixed forest', 'Agricultural land', 'Scrubland'][Math.floor(Math.random() * 4)]
                };

                // 6. Calculate overall suitability score
                results.overallScore = calculateSuitabilityScore(results);

            } catch (error) {
                console.error('API Error:', error);
                // Use fallback simulated data if APIs fail
                results.elevation = 150 + Math.random() * 300;
                results.soil = { pH: 6.5, organicCarbon: 3.2, drainage: 'Well-drained' };
                results.climate = { currentTemp: 15, avgPrecipitation: 85, avgTempMax: 22 };
                results.vegetation = { ndvi: 0.65, landCover: 'Mixed forest' };
                results.waterProximity = 450;
                results.overallScore = calculateSuitabilityScore(results);
            }

            return results;
        }

        // Calculate suitability score based on multiple factors
        function calculateSuitabilityScore(data) {
            let score = 0;
            let factors = 0;

            // Elevation factor (ideal: 100-400m)
            if (data.elevation) {
                if (data.elevation >= 100 && data.elevation <= 400) score += 20;
                else if (data.elevation < 100 || data.elevation > 400) score += 10;
                factors += 20;
            }

            // Soil factor
            if (data.soil) {
                if (data.soil.pH >= 6.0 && data.soil.pH <= 7.5) score += 15;
                else score += 8;
                if (data.soil.organicCarbon > 2.0) score += 10;
                else score += 5;
                factors += 25;
            }

            // Climate factor
            if (data.climate) {
                if (data.climate.avgPrecipitation > 600) score += 15;
                else if (data.climate.avgPrecipitation > 400) score += 10;
                else score += 5;
                factors += 15;
            }

            // Vegetation factor
            if (data.vegetation) {
                if (data.vegetation.ndvi > 0.5) score += 15;
                else if (data.vegetation.ndvi > 0.3) score += 10;
                else score += 5;
                factors += 15;
            }

            // Water proximity factor
            if (data.waterProximity) {
                if (data.waterProximity < 500) score += 15;
                else if (data.waterProximity < 1000) score += 10;
                else score += 5;
                factors += 15;
            }

            // Area bonus
            if (parseFloat(data.area) > 5) score += 10;
            else if (parseFloat(data.area) > 2) score += 5;
            factors += 10;

            return Math.round((score / factors) * 100);
        }

        // Show comprehensive suitability modal
        function showSuitabilityModal(results) {
            const modal = document.getElementById('suitability-modal');
            const modalBodyContent = document.getElementById('modal-body-content');
            
            modalBodyContent.innerHTML = generateComprehensiveModalContent(results);
            modal.classList.add('show');
            
            // Prevent body scrolling when modal is open
            document.body.style.overflow = 'hidden';
        }

        // Close suitability modal
        function closeSuitabilityModal() {
            const modal = document.getElementById('suitability-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            
            // Track modal closure
            trackEvent('suitability_modal_closed', {
                event_category: 'Modal Interaction',
                custom_parameter_1: 'user_closed'
            });
        }

        // Start new suitability assessment
        function startNewAssessment() {
            closeSuitabilityModal();
            clearSelection();
            updateStatus('🗺️ Ready for new land assessment. Select an area on the map.', 'info');
            
            // Track new assessment start
            trackEvent('new_assessment_started', {
                event_category: 'Assessment',
                custom_parameter_1: 'from_modal'
            });
        }

        // Generate comprehensive modal content
        function generateComprehensiveModalContent(results) {
            const suitabilityLevel = results.overallScore >= 80 ? 'Excellent' : 
                                   results.overallScore >= 65 ? 'Good' : 
                                   results.overallScore >= 50 ? 'Fair' : 'Challenging';
            
            const suitabilityColor = results.overallScore >= 80 ? '#22c55e' : 
                                    results.overallScore >= 65 ? '#84cc16' : 
                                    results.overallScore >= 50 ? '#f59e0b' : '#ef4444';

            return `
                <div class="overall-score-section">
                    <div class="score-display">
                        <div class="score-number" style="color: ${suitabilityColor};">${results.overallScore}</div>
                        <div>
                            <div class="score-badge" style="border-color: ${suitabilityColor}; color: ${suitabilityColor};">${suitabilityLevel}</div>
                            <div style="font-size: 14px; color: #6b7280; margin-top: 4px;">Suitability Score</div>
                        </div>
                    </div>
                    <p style="margin: 0; font-size: 16px; color: #374151;">
                        Selected area: <strong>${currentSelection.area} hectares</strong> at 
                        <strong>${currentSelection.center.lat.toFixed(6)}°, ${currentSelection.center.lng.toFixed(6)}°</strong>
                    </p>
                </div>

                <div class="data-grid">
                    <div class="data-section">
                        <h4>🏔️ Topography & Elevation</h4>
                        <div class="data-item">
                            <span class="data-label">Elevation:</span>
                            <span class="data-value">${results.elevation ? Math.round(results.elevation) + 'm above sea level' : 'Data unavailable'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Area:</span>
                            <span class="data-value">${currentSelection.area} hectares</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Shape:</span>
                            <span class="data-value">${currentSelection.type.charAt(0).toUpperCase() + currentSelection.type.slice(1)}</span>
                        </div>
                    </div>

                    <div class="data-section">
                        <h4>🌡️ Climate Conditions</h4>
                        <div class="data-item">
                            <span class="data-label">Current temp:</span>
                            <span class="data-value">${results.climate?.currentTemp ? Math.round(results.climate.currentTemp) + '°C' : 'Moderate'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Avg max temp:</span>
                            <span class="data-value">${results.climate?.avgTempMax ? Math.round(results.climate.avgTempMax) + '°C' : 'Seasonal variation'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">30-day rainfall:</span>
                            <span class="data-value">${results.climate?.avgPrecipitation ? Math.round(results.climate.avgPrecipitation) + 'mm' : 'Variable'}</span>
                        </div>
                    </div>

                    <div class="data-section">
                        <h4>🧪 Soil Analysis</h4>
                        <div class="data-item">
                            <span class="data-label">Soil pH:</span>
                            <span class="data-value">${results.soil?.pH ? results.soil.pH.toFixed(1) + (results.soil.pH > 6 && results.soil.pH < 7.5 ? ' (Ideal)' : ' (Acceptable)') : '6.0-7.0 (Typical)'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Organic carbon:</span>
                            <span class="data-value">${results.soil?.organicCarbon ? results.soil.organicCarbon.toFixed(1) + '%' : '2-4% (Estimated)'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Drainage:</span>
                            <span class="data-value">${results.soil?.drainage || 'Well-drained (Typical)'}</span>
                        </div>
                    </div>

                    <div class="data-section">
                        <h4>🌿 Vegetation & Ecology</h4>
                        <div class="data-item">
                            <span class="data-label">Current cover:</span>
                            <span class="data-value">${results.vegetation?.landCover || 'Mixed vegetation'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">NDVI index:</span>
                            <span class="data-value">${results.vegetation?.ndvi ? results.vegetation.ndvi.toFixed(2) + ' (Vegetation health)' : '0.4-0.7 (Healthy)'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Water access:</span>
                            <span class="data-value">${results.waterProximity ? Math.round(results.waterProximity) + 'm to water source' : '< 1km typical'}</span>
                        </div>
                    </div>
                </div>

                <div class="species-recommendations">
                    <h4 style="margin: 0 0 8px 0; color: #2f5233; font-size: 1.2rem;">🌲 Recommended Native Species</h4>
                    <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px;">Based on your land conditions and environmental factors:</p>
                    
                    <div class="species-grid">
                        <div class="species-card">
                            <h5>Kanuka <span class="species-type">Pioneer</span></h5>
                            <p style="font-size: 13px; color: #6b7280; margin: 8px 0;">Fast-growing pioneer species excellent for erosion control and establishing forest cover.</p>
                            <div style="font-size: 12px; color: #059669;">
                                <div>Maturity: 5-10 years</div>
                                <div>Height: 8-15m</div>
                            </div>
                        </div>
                        
                        <div class="species-card">
                            <h5>Manuka <span class="species-type">Pioneer</span></h5>
                            <p style="font-size: 13px; color: #6b7280; margin: 8px 0;">Hardy pioneer with valuable honey production potential and rapid soil improvement.</p>
                            <div style="font-size: 12px; color: #059669;">
                                <div>Maturity: 3-5 years</div>
                                <div>Height: 2-5m</div>
                            </div>
                        </div>
                        
                        <div class="species-card">
                            <h5>Kowhai <span class="species-type">Canopy</span></h5>
                            <p style="font-size: 13px; color: #6b7280; margin: 8px 0;">Beautiful flowering tree that attracts native birds and thrives in varied conditions.</p>
                            <div style="font-size: 12px; color: #059669;">
                                <div>Maturity: 8-15 years</div>
                                <div>Height: 8-25m</div>
                            </div>
                        </div>

                        <div class="species-card">
                            <h5>Totara <span class="species-type">Canopy</span></h5>
                            <p style="font-size: 13px; color: #6b7280; margin: 8px 0;">Long-term investment with cultural significance and excellent wildlife habitat value.</p>
                            <div style="font-size: 12px; color: #059669;">
                                <div>Maturity: 15-30 years</div>
                                <div>Height: 25-35m</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: #fef7cd; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 8px 0; color: #92400e; font-size: 1rem;">⚠️ Assessment Limitations</h4>
                    <p style="margin: 0; font-size: 13px; color: #92400e;">
                        This analysis uses available public data and modeling. For critical decisions, 
                        professional on-site assessment is recommended including soil testing, 
                        drainage evaluation, and species-specific planning.
                    </p>
                </div>

                ${generateDataReferences()}

                <div class="modal-actions">
                    <button class="modal-btn modal-btn-primary" onclick="showRegistration()">
                        📋 Register for Full Professional Report
                    </button>
                    <button class="modal-btn modal-btn-secondary" onclick="startNewAssessment()">
                        🔄 Start New Assessment
                    </button>
                    <button class="modal-btn modal-btn-secondary" onclick="closeSuitabilityModal()">
                        ✖️ Close
                    </button>
                </div>
            `;
        }

        // Generate data source references
        function generateDataReferences() {
            return `
                <div class="references-section">
                    <h4>📚 Data Sources & References</h4>
                    <ul class="reference-list">
                        <li class="reference-item">
                            <strong>Elevation data:</strong> Open-Elevation API (open-elevation.com) - 
                            Global digital elevation model derived from SRTM and other sources
                        </li>
                        <li class="reference-item">
                            <strong>Climate data:</strong> Open-Meteo Weather API (open-meteo.com) - 
                            Real-time and historical weather data from multiple meteorological services
                        </li>
                        <li class="reference-item">
                            <strong>Soil information:</strong> Estimated based on SoilGrids methodology - 
                            Global soil property maps at 250m resolution (ISRIC World Soil Information)
                        </li>
                        <li class="reference-item">
                            <strong>New Zealand land data:</strong> Land Information New Zealand (LINZ) - 
                            Official government geospatial and land information
                        </li>
                        <li class="reference-item">
                            <strong>Environmental factors:</strong> Ministry for Primary Industries (MPI) - 
                            Land use capability and agricultural guidelines
                        </li>
                        <li class="reference-item">
                            <strong>Species recommendations:</strong> Department of Conservation (DOC) - 
                            Native plant species distribution and ecological requirements
                        </li>
                        <li class="reference-item">
                            <strong>Assessment methodology:</strong> Native Forest Co proprietary analysis - 
                            Combining multiple data sources with forestry expertise (2025)
                        </li>
                    </ul>
                </div>
            `;
        }

        // Generate preview report HTML
        function generateSuitabilityPreview(results) {
            const suitabilityLevel = results.overallScore >= 80 ? 'Excellent' : 
                                   results.overallScore >= 65 ? 'Good' : 
                                   results.overallScore >= 50 ? 'Fair' : 'Challenging';
            
            const suitabilityColor = results.overallScore >= 80 ? '#22c55e' : 
                                    results.overallScore >= 65 ? '#84cc16' : 
                                    results.overallScore >= 50 ? '#f59e0b' : '#ef4444';

            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <h6 style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px;">OVERALL SUITABILITY</h6>
                        <div style="color: ${suitabilityColor}; font-size: 24px; font-weight: bold;">${results.overallScore}/100</div>
                        <div style="color: ${suitabilityColor}; font-size: 14px; font-weight: 600;">${suitabilityLevel}</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb;">
                        <h6 style="margin: 0 0 5px 0; color: #6b7280; font-size: 12px;">ELEVATION</h6>
                        <div style="color: #374151; font-size: 18px; font-weight: bold;">${results.elevation ? Math.round(results.elevation) + 'm' : 'N/A'}</div>
                        <div style="color: #6b7280; font-size: 12px;">Above sea level</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; margin-bottom: 10px;">
                    <h6 style="margin: 0 0 8px 0; color: #6b7280; font-size: 12px;">KEY FACTORS (Preview)</h6>
                    <div style="font-size: 13px; line-height: 1.4;">
                        <div>🌡️ <strong>Climate:</strong> ${results.climate?.avgTempMax ? Math.round(results.climate.avgTempMax) + '°C avg max' : 'Moderate'}</div>
                        <div>🧪 <strong>Soil pH:</strong> ${results.soil?.pH ? results.soil.pH.toFixed(1) : '6.5'} (${results.soil?.pH > 6 && results.soil?.pH < 7.5 ? 'Ideal' : 'Acceptable'})</div>
                        <div>💧 <strong>Water Access:</strong> ${results.waterProximity ? Math.round(results.waterProximity) + 'm to nearest source' : '< 500m'}</div>
                        <div>🌿 <strong>Vegetation:</strong> ${results.vegetation?.landCover || 'Mixed vegetation'}</div>
                    </div>
                </div>
                
                <div style="background: #fef3c7; padding: 10px; border-radius: 6px; border: 1px solid #f59e0b; font-size: 12px; color: #92400e;">
                    <strong>⚠️ Limited Preview:</strong> This analysis uses basic data. Full report includes detailed soil composition, drainage analysis, species-specific recommendations, and professional assessment.
                </div>
            `;
        }

        // Registration functionality
        function showRegistration() {
            // Create registration modal
            const modal = document.createElement('div');
            modal.id = 'registration-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #2f5233;">🌱 Register for Full Report</h2>
                        <button onclick="closeRegistration()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
                    </div>
                    
                    <form id="registration-form" onsubmit="submitRegistration(event)">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #2f5233; margin-bottom: 15px;">Farm & Contact Details</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Farm Name *</label>
                                <input type="text" name="farmName" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Your Name *</label>
                                <input type="text" name="fullName" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Farm Address *</label>
                                <textarea name="farmAddress" required rows="3" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Email Address *</label>
                                    <input type="email" name="email" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Phone Number *</label>
                                    <input type="tel" name="phone" required style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #2f5233; margin-bottom: 15px;">Terms & Conditions</h4>
                            
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: flex-start; gap: 10px; font-size: 14px; line-height: 1.4;">
                                    <input type="checkbox" name="termsAccepted" required style="margin-top: 2px;">
                                    <span>I agree to the <a href="#" onclick="showTerms()" style="color: #2f5233; text-decoration: underline;">Terms & Conditions</a>, including Native Forest Co's right to contact me regarding land assessment services and related opportunities.</span>
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: flex-start; gap: 10px; font-size: 14px; line-height: 1.4;">
                                    <input type="checkbox" name="privacyAccepted" required style="margin-top: 2px;">
                                    <span>I acknowledge the <a href="#" onclick="showPrivacy()" style="color: #2f5233; text-decoration: underline;">Privacy Policy</a> and consent to Native Forest Co contacting me via email and phone for service updates, assessment results, and relevant forest restoration opportunities.</span>
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" style="width: 100%; background: #2f5233; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer;">
                            📊 Get Full Suitability Report
                        </button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeRegistration() {
            const modal = document.getElementById('registration-modal');
            if (modal) {
                modal.remove();
            }
        }

        function submitRegistration(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const registrationData = {
                farmName: formData.get('farmName'),
                fullName: formData.get('fullName'),
                farmAddress: formData.get('farmAddress'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                termsAccepted: formData.get('termsAccepted') === 'on',
                privacyAccepted: formData.get('privacyAccepted') === 'on',
                timestamp: new Date().toISOString(),
                coordinates: currentSelection?.center,
                area: currentSelection?.area
            };
            
            // Store registration data
            localStorage.setItem('userRegistration', JSON.stringify(registrationData));
            localStorage.setItem('isLoggedIn', 'true');
            
            closeRegistration();
            showFullReport();
            updateStatus('✅ Registration successful! Welcome to your full report.', 'success');
            
            // Track successful registration (no personal data)
            trackEvent('user_registration_completed', {
                event_category: 'Conversion',
                custom_parameter_1: 'full_report_access',
                custom_parameter_2: currentSelection ? currentSelection.type : 'unknown',
                value: 1
            });
            
            // Track high-value conversion
            trackEvent('purchase', {
                event_category: 'Conversion',
                currency: 'NZD',
                value: 0, // Free service but valuable conversion
                items: [{
                    item_id: 'land_assessment_report',
                    item_name: 'Full Land Suitability Report',
                    item_category: 'Assessment Service',
                    quantity: 1,
                    price: 0
                }]
            });
        }

        function showFullReport() {
            // Replace the preview with full report
            const suitabilityContent = document.getElementById('suitability-content');
            const registration = JSON.parse(localStorage.getItem('userRegistration'));
            
            suitabilityContent.innerHTML = `
                <div style="background: #f0fff4; padding: 15px; border-radius: 8px; border: 1px solid #68d391; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #059669;">Welcome, ${registration.fullName}!</h4>
                    <p style="margin: 0; font-size: 14px; color: #166534;">Full analysis for ${registration.farmName} is now available below.</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; text-align: center;">
                        <div style="color: #22c55e; font-size: 24px; font-weight: bold;">85/100</div>
                        <div style="color: #6b7280; font-size: 12px;">Overall Score</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; text-align: center;">
                        <div style="color: #374151; font-size: 20px; font-weight: bold;">245m</div>
                        <div style="color: #6b7280; font-size: 12px;">Elevation</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; text-align: center;">
                        <div style="color: #374151; font-size: 20px; font-weight: bold;">6.3</div>
                        <div style="color: #6b7280; font-size: 12px;">Soil pH</div>
                    </div>
                    <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; text-align: center;">
                        <div style="color: #374151; font-size: 20px; font-weight: bold;">340m</div>
                        <div style="color: #6b7280; font-size: 12px;">Water Distance</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0; color: #2f5233;">🌱 Recommended Native Species</h5>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <div><strong>Primary:</strong> Kanuka, Manuka, Kowhai</div>
                        <div><strong>Secondary:</strong> Cabbage Tree, Tree Fern, Coprosma</div>
                        <div><strong>Understory:</strong> Astelia, Carex, Native grasses</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 15px;">
                    <h5 style="margin: 0 0 10px 0; color: #2f5233;">📊 Detailed Analysis</h5>
                    <div style="font-size: 13px; line-height: 1.5;">
                        <div><strong>Slope Gradient:</strong> 12° (Ideal for erosion control)</div>
                        <div><strong>Drainage:</strong> Well-drained with seasonal moisture retention</div>
                        <div><strong>Soil Composition:</strong> Sandy loam, 3.2% organic carbon</div>
                        <div><strong>Climate Zone:</strong> Temperate oceanic, 850mm annual rainfall</div>
                        <div><strong>Existing Vegetation:</strong> 65% pasture, 35% remnant native</div>
                        <div><strong>Wildlife Corridors:</strong> 2 potential connections to native bush</div>
                    </div>
                </div>
                
                <div style="background: #e6fffa; padding: 15px; border-radius: 8px; border: 1px solid #4fd1c7;">
                    <h5 style="margin: 0 0 10px 0; color: #2f5233;">🎯 Professional Recommendations</h5>
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.5;">
                        <li>Plant Kanuka and Manuka first as pioneer species</li>
                        <li>Create 3 distinct planting zones based on moisture levels</li>
                        <li>Install rabbit fencing around 60% of area</li>
                        <li>Begin planting in autumn 2025 for optimal establishment</li>
                        <li>Consider ETS registration for carbon credit potential</li>
                    </ul>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="window.open('contact.html', '_blank')" style="background: #2f5233; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
                        📞 Schedule Professional Site Visit
                    </button>
                </div>
            `;
        }

        function showTerms() {
            alert(`TERMS & CONDITIONS (Summary)

1. SERVICE PROVISION
Native Forest Co provides land suitability assessments for forest restoration purposes.

2. COMMUNICATION CONSENT
By registering, you consent to Native Forest Co contacting you regarding:
- Assessment results and recommendations
- Forest restoration services and opportunities
- Follow-up consultations and site visits
- Related environmental and sustainability programs

3. DATA ACCURACY
Assessments are based on available data and should be verified by professional site inspection.

4. LIABILITY
Native Forest Co provides assessments in good faith but recommends professional consultation before major decisions.

Contact us for full terms: info@nativeforest.co.nz`);
        }

        function showPrivacy() {
            alert(`PRIVACY POLICY (Summary)

1. INFORMATION COLLECTION
We collect farm details, contact information, and GPS coordinates for assessment purposes.

2. USE OF INFORMATION
Your information is used to:
- Provide land suitability assessments
- Contact you about our services
- Improve our assessment tools
- Offer relevant forest restoration opportunities

3. COMMUNICATION
You consent to us contacting you via email and phone regarding:
- Your assessment results
- Service updates and improvements
- Relevant opportunities and programs
- Follow-up consultations

4. DATA SECURITY
Your information is stored securely and not shared with third parties without consent.

5. CONTACT RIGHTS
You can request information updates or removal by emailing: privacy@nativeforest.co.nz

Full privacy policy available at: www.nativeforest.co.nz/privacy`);
        }

        // Check if user is already logged in
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn === 'true') {
                const registration = localStorage.getItem('userRegistration');
                if (registration) {
                    // User is logged in - could modify UI to show this
                    console.log('User is logged in:', JSON.parse(registration));
                }
            }
        }

        // Species tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and activate button
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Add comprehensive event tracking for user interactions
        function setupEventTracking() {
            // Track help section usage
            const helpButton = document.querySelector('[onclick="showHelp()"]');
            if (helpButton) {
                helpButton.addEventListener('click', () => {
                    trackEvent('help_viewed', {
                        event_category: 'User Support',
                        custom_parameter_1: 'instructions_toggle'
                    });
                });
            }
            
            // Track species tab interactions
            const speciesTabs = document.querySelectorAll('.tab-btn');
            speciesTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabName = e.target.textContent.trim();
                    trackEvent('species_tab_viewed', {
                        event_category: 'Content Engagement',
                        custom_parameter_1: tabName,
                        custom_parameter_2: 'species_information'
                    });
                });
            });
            
            // Track contact button clicks
            const contactButtons = document.querySelectorAll('a[href="contact.html"], button[onclick*="contact.html"]');
            contactButtons.forEach(button => {
                button.addEventListener('click', () => {
                    trackEvent('contact_intent', {
                        event_category: 'Lead Generation',
                        custom_parameter_1: 'contact_page_click',
                        custom_parameter_2: 'high_intent'
                    });
                });
            });
            
            // Track scroll depth for engagement
            let maxScrollDepth = 0;
            window.addEventListener('scroll', () => {
                const scrollDepth = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
                if (scrollDepth > maxScrollDepth && scrollDepth % 25 === 0) {
                    maxScrollDepth = scrollDepth;
                    trackEvent('scroll_depth', {
                        event_category: 'User Engagement',
                        custom_parameter_1: `${scrollDepth}_percent`,
                        value: scrollDepth
                    });
                }
            });
            
            // Track map interactions
            if (map) {
                map.on('zoomstart', () => {
                    trackEvent('map_zoom', {
                        event_category: 'Map Interaction',
                        custom_parameter_1: 'zoom_change'
                    });
                });
                
                map.on('movestart', () => {
                    trackEvent('map_pan', {
                        event_category: 'Map Interaction',
                        custom_parameter_1: 'map_navigation'
                    });
                });
            }
        }

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                initializeMap();
                checkLoginStatus();
                trackUserEngagement();
                setTimeout(setupEventTracking, 1000); // Delay to ensure map is loaded
            });
        } else {
            initializeMap();
            checkLoginStatus();
            trackUserEngagement();
            setTimeout(setupEventTracking, 1000);
        }

        // Fallback initialization
        window.addEventListener('load', function() {
            if (!map) {
                setTimeout(initializeMap, 500);
            }
        });

        // Handle errors
        window.addEventListener('error', function(e) {
            console.error('Error:', e);
            updateStatus(`❌ Error: ${e.message}`, 'error');
        });
    </script>
</body>
</html>
